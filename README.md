
# Message
## 目标
此次完成目标侧重于在有限的时间内尽可能将所有功能点完成，并且能 work；因此在应用的设计、代码的质量以及可拓展性方面比较弱。
## 概述
目前实现基本覆盖所有功能点（可能存在 bug），为了追求客户端性能，实时交互技术采用 websocket，如用户的收发信息。
	后端采用 `Python`，利用 `Tornado` 框架；前端采用 `Vue.js` 框架，这里基于一个开源 [Demo](https://github.com/Coffcer/vue-chat)。
	存储采用 `MongoDB` 和 `Redis`，`MongoDB` 作为核心数据存储，`Redis` 提供例如 `Session Key` 的查询。
## 后端整体逻辑
由于业务需求是私信场景，所以一般用户联系人不会像粉丝社交那样拥有几百万几千万粉丝，最多就几百个，考虑到 80 % 以上请求的查询性能，所以把好友关系冗余在用户表里，包括未读数和最后一次信息，这样在用户表里查询一次就能获取所有所需数据，并且用户表相较其他表是记录数最少的，保证了查询效率。（由于增改未读数，好友，信息都需要读写用户表，用户表将来很可能成为性能瓶颈，可以考虑放到缓存中，实际项目应该分开用户表和账户表，允许不同类型账户的登陆，也避免用户表过大。本次实现并没有加入常规的登陆状态。）
消息表没有什么特别，存放消息发送和接收者、内容、时间等。
## 后端功能具体逻辑
#### 1. 登陆注册
通过用户名和密码进行注册，登录后设置 `security_cookie`，值为加密的 `access_token`，并和用户名对应存入 `Redis`，请求需要登录权限的接口时，携带 `security_cookie` 进行验证。（请求跨域问题处理了很久...）
#### 2. Websocket
大部分的逻辑包括收发消息等都在 `on_message` 方法中处理，根据解析 `type` 参数来分发做不同的功能处理，如：`get_friends`、`get_messages`、`send_message`、`read_message`、`delete_message`。
返回也携带类型，让前端依次做类似的判断处理。
而发送消息，则是维护一个全局的已连接 `socket client` 映射。
`on_message` 方法和 `socket_pool` 在将来很可能成为瓶颈，目前做法比较简单粗暴，生产环境可能需要考虑分布式集群。
#### 3. 其他也提供 RESTful API 如「搜索好友」、「删除好友」等。
## 前端 on_message 逻辑伪代码
#### 事件一：登陆成功
发起 `websocket` 连接，先调用`「3」`接口获取联系人列表，包括显示未读数，以及最后一条消息。
#### 事件二：监听 on_message 方法接收消息
收到的消息有 4 种：
##### 1. 实时消息，type 为 message
```
先判断用户是否在该消息 `from_user` 的对话框中（因此需要有个变量记录用户在哪个人的对话框），
	如果在，
			如果 `from_user == to_user`，则将 `from_user` 改为自己，再添加到和这个人的对话列表。（这条其实是自己发送的回显）
			否则直接添加到和这个人的对话列表，调用 `socket send` 方法发送确认已读请求，具体请求参数为 `「7.5」`。
	如果不在，不添加消息，但需要将改对话的未读数加 1。
```
##### 2. 拉取消息的返回，type 为 get_messages
```
会拉取消息表明用户一定是点击进入该对话框，直接添加到和这个人的对话列表。
```
##### 3. 获取好友列表的返回， type 为 get_friends
```
直接替换原有好友列表数据。
```
##### 4. 消息被删除，type 为 delete_message
```
先判断用户是否在该消息 `from_user` 的对话框中
		如果在，将对话列表中 指定 `id` 消息移除
		如果不在，且有和这个用户的未读数，则未读数减 1 （这里有 bug，因为这条被删除消息不一定是未读的），否则什么也不做。
```
#### 事件三：用户发送一条消息
前端层面不添加到对话列表因为这条没有 ID 之后无法删除，再调用 `socket send` 方法发送，具体请求参数为 `「7.3」`

#### 事件四：用户一旦进入一个对话框
##### 1. 有未读数的对话框
```
先在前端层面将未读数置 0
		如果该对话在本地有历史消息即对话列表不为空，则调用拉取消息方法`「7.2」`，`min_ts` 参数值为最后一条消息时间戳，`size` 为未读数
		如果没有此前没有过对话，则调用拉取消息方法`「7.2」`，`min_ts` 参数不传，`size` 为未读数。
```
##### 2. 无未读数的对话框
```
如果没有此前没有过对话，则调用拉取消息方法`「7.2」`，`min_ts` 和 `size` 参数都不传
```
##### 3. 用户点击了查看历史消息按钮（相当于向下滚动）
```
如果有对话列表，则调用拉取消息方法`「7.2」`，`max_ts` 参数值为列表第一条消息时间戳，`size` 不传。
```
##### 4. 用户点击了每条消息上的删除按钮（只有自己发的消息有）
```
前端层面把消息从列表中删除，并发送删除消息请求 `「7.7」`
```
#### 事件五
搜索好友，调用`「4」`

#### 事件六
删除好友，调用`「5」`
## API
#### 「1」登陆
```
描述
无

接口
/api/login POST

参数
{
	"user_name": "lisi",
	"password": "123456"
}

返回
{
  "message": "success"
}
```
####「2」 注册
```
描述
无

接口
/api/register POST
参数
{
	"user_name": "lisi",
	"password": "123456"
}
返回
{
  "user_name": "lisi"
}
```
####「3」 获取好友列表
```
描述
返回的好友未读数用于显示，最后一条信息用于显示预览，该字段可能没有，前端需要做判断没有显示空。

接口
/api/friends GET

参数
无

返回
[
  {
    "last_message": "hello16",
    "unread_count": 0,
    "user_name": "lisi",
    "last_time": 1490203238
  }
]
```
####「4」 添加好友
```
描述
该接口可能不需要了，搜索好友后发送消息后端直接互相加为好友。

接口
/api/add_friend/(?P<friend_name>[^/]+) POST

参数
无

返回
{
  "message": "success"
}
```
####「5」 删除好友
```
描述
无

接口
/api/remove_friend/(?P<friend_name>[^/]+) DELETE

返回
{
  "message": "success"
}
```
####「6」 查找一个好友
```
描述
无

接口
/api/find_friend/(?P<friend_name>[^/]+) GET

参数
无

返回
{
  "user_name": "lisi",
  "is_your_friend": true
}
```
####「7」 WebSocket
```
描述
开启连接时的接口，后序通信根据传递参数来做具体不同的功能。

接口
ws://host/api/message
```
#####「7.1」 获取好友列表
```
描述
无

参数
{
	"type": "get_friends"
}

返回
{
    "type": "get_friends",
    "friends": [
        {
            "last_message": "hello16",
            "unread_count": 0,
            "user_name": "lisi",
            "last_time": 1490203238
        }
    ]
}
```
#####「7.2」获取消息
```
描述
返回均按时间倒序，这点前端在得到历史消息和新消息可能需要不同的插入方式

参数
{
	"type": "get_messages",
	"friend_name": "wangwu",
	"max_ts": 1490203238, （optional，不可和 min_ts 一起传，表示小于这个时间戳的消息，即历史消息）
	"min_ts": 1490203238, （optional，不可和 max_ts 一起传，表示大于这个时间戳的消息，即新消息）
	"size": 10（optional，可根据未读数传）
}

返回
{
	"type": "get_messages",
	"friend_name": "lisi",
	"message": [
				{
            		"content": "hello16",
            		"from_user": "lisi",
            		"to_user": "lisi",
            		"create_at": 1490203238,
            		"id": "123"
        		}
	]
}
```
#####「7.3」发送消息
```
描述
无

参数
{
	"type": "send_message",
	"friend_name": "wangwu",
	"content": "hello"
}

返回
无
```
#####「7.4」接收实时消息
```
描述
无

参数
无

返回
{
	"type": "message",
	"content": "hello16",
	"from_user": "lisi",
	"to_user": "lisi",
	"create_at": 1490203238,
	"id": "123"
}
```
#####「7.5」确认已读
```
描述
无

参数
{
	"friend_name": "lisi"
}

返回
无
```
#####「7.6」接收删除消息
```
描述
无

参数
无

返回
{
	"type": "delete_message",
	"from_user": "lisi",
	"id": "123"
}
```
#####「7.7」发送删除消息
```
描述
无

参数
{
	"type": "send_message",
	"id": "123",
	"friend_name": "wangwu"
}

返回
无
```




